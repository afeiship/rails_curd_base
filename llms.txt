# RailsCurdBase - AI Assistant Guide

> RailsCurdBase is a Ruby on Rails CRUD base controller gem providing ready-to-use Create, Read, Update, Delete functionality with advanced query capabilities including pagination, sorting, searching, and filtering. It uses RailsWarp for unified JSON responses and Kaminari for pagination.

**IMPORTANT NOTES FOR AI ASSISTANTS:**
- RailsCurdBase inherits from ActionController::API for Rails API applications
- All responses use RailsWarp unified format: { success: boolean, code: integer, msg: string, data: object }
- Controllers automatically derive resource class from controller name (Api::PostsController => Post model)
- Built-in Queryable concern provides pagination, sorting, searching, filtering
- Four lifecycle hooks: before_create, after_create, before_update, after_update
- Resource automatically derived: controller_name.singularize.classify.constantize
- Success responses use default "success" message from RailsWarp (no custom message)
- Error responses keep custom messages ("Validation failed", "Record not found")

## DOCUMENTATION LINKS

- Repository: https://github.com/aferic/rails_curd_base
- Usage Guide: test/dummy/EXAMPLE_USAGE.md (complete API documentation and examples)
- Test/Demo App: test/dummy/ directory (fully working example)

## CORE FEATURES

### 1. Zero-Configuration CRUD
Inherit from CurdController to get complete CRUD:
- index: List with query capabilities (pagination, sorting, searching, filtering)
- show: Single record retrieval
- create: Create new records
- update: Update existing records
- destroy: Delete records

### 2. Queryable Module (supports_query)
Configure via supports_query:
- **Pagination**: page, size parameters (Kaminari)
- **Sorting**: sort parameter (supports -field for desc)
- **Searching**: q parameter (multi-field LIKE search)
- **Filtering**: filter parameter (eq, neq, gt, gte, lt, lte, in, nin operators)

### 3. Unified Response Format (RailsWarp)
- ok: success response with data, code
- fail: error response with message, code, errors data

### 4. Lifecycle Hooks
- before_create(resource): called before create, return false to abort
- after_create(resource): called after successful create
- before_update(resource): called before update, return false to abort
- after_update(resource): called after successful update

### 5. Automatic Resource Derivation
- resource_class: Model class (auto-derived from controller name)
- resource_key: Parameter symbol (:post, :user, etc.)
- resource: Current resource instance (@post, @user, etc.)

## INSTALLATION

Add to Gemfile:
```ruby
gem 'rails_curd_base'
```

Run:
```bash
bundle install
```

## BASIC USAGE

### Create Controller
```ruby
class Api::PostsController < RailsCurdBase::CurdController
  supports_query(
    pagination: { enabled: true, default_per: 10, max_per: 50 },
    sorting: { enabled: true, allowed_fields: [:id, :title, :created_at] },
    searching: { enabled: true, searchable_fields: [:title, :content] },
    filtering: { enabled: true, filterable_fields: [:status] }
  )
end
```

### API Endpoints
```bash
# List (with pagination, sorting, searching, filtering)
GET /api/posts?page=1&size=10&sort=-created_at&q=rails&filter[status]=published

# Show single
GET /api/posts/1

# Create (flat format - recommended)
POST /api/posts
{"title": "Hello", "content": "World", "status": "published"}

# Create (nested format - also supported)
POST /api/posts
{"post": {"title": "Hello", "content": "World", "status": "published"}}

# Update (flat format - recommended)
PUT /api/posts/1
{"title": "Updated"}

# Delete
DELETE /api/posts/1
```

## RESPONSE FORMAT

### Success Response
```json
{
  "success": true,
  "code": 200,
  "msg": "success",
  "data": { ... }
}
```

### Error Response
```json
{
  "success": false,
  "code": 422,
  "msg": "Validation failed",
  "data": {
    "errors": ["Title can't be blank"]
  }
}
```

## QUERYABLE CONFIGURATION

### Pagination
```ruby
supports_query(
  pagination: {
    enabled: true,
    default_per: 20,
    max_per: 100,
    page_param: :page,
    per_param: :size
  }
)
```

### Sorting
```ruby
supports_query(
  sorting: {
    enabled: true,
    allowed_fields: [:id, :title, :created_at],
    sort_param: :sort
  }
)
# Usage: ?sort=field or ?sort=-field (desc)
```

### Searching
```ruby
supports_query(
  searching: {
    enabled: true,
    searchable_fields: [:title, :content],
    search_param: :q
  }
)
# Usage: ?q=search_term
# Performs: WHERE field LIKE '%term%' OR field2 LIKE '%term%'
```

### Filtering
```ruby
supports_query(
  filtering: {
    enabled: true,
    filterable_fields: [:status, :category_id],
    filter_param: :filter
  }
)
```

Supported operators:
- `?filter[field]=value` → Equals (eq)
- `?filter[field][neq]=value` → Not equals (neq)
- `?filter[field][gt]=value` → Greater than (gt)
- `?filter[field][gte]=value` → Greater than or equal (gte)
- `?filter[field][lt]=value` → Less than (lt)
- `?filter[field][lte]=value` → Less than or equal (lte)
- `?filter[field][in]=1,2,3` → In array (in)
- `?filter[field][nin]=1,2,3` → Not in array (nin)

## CUSTOMIZATION

### Override Collection (Scope Data)
```ruby
class Api::PostsController < RailsCurdBase::CurdController
  def collection
    current_user.posts  # Only current user's posts
  end
end
```

### Lifecycle Hooks
```ruby
class Api::PostsController < RailsCurdBase::CurdController
  def before_create(resource)
    resource.author = current_user
    resource.published_at = Time.current if resource.status == 'published'
    true  # Must return true to continue
  end

  def after_create(resource)
    NotificationService.notify(resource)
  end
end
```

### Custom Resource Class
```ruby
class Api::PostsController < RailsCurdBase::CurdController
  def resource_class
    CustomPost  # Override auto-derivation
  end
end
```

### Custom Serialization
```ruby
class Api::PostsController < RailsCurdBase::CurdController
  private

  def serialize_resource(resource)
    {
      id: resource.id,
      title: resource.title,
      summary: resource.content.truncate(100)
    }
  end

  def serialize_collection(collection)
    collection.map { |r| serialize_resource(r) }
  end
end
```

### Add Authentication/Authorization
```ruby
class Api::PostsController < RailsCurdBase::CurdController
  before_action :authenticate_user!
  before_action :set_post, only: [:show, :update, :destroy]

  private

  def authenticate_user!
    head :unauthorized unless current_user
  end

  def set_post
    @post = current_user.posts.find_by(id: params[:id])
  end
end
```

## NAMING CONVENTIONS

- Controller: Api::ResourcesController or ResourcesController
- Model: Resource (auto-derived)
- Parameter: :resource (auto-derived)
- Instance: @resource (auto-derived)

Examples:
- Api::UsersController => User model, :user param, @user instance
- Api::PostsController => Post model, :post param, @post instance
- Api::CommentsController => Comment model, :comment param, @comment instance

## COMMON PATTERNS

### Nested Resources
```ruby
def collection
  user.posts  # Assumes params[:user_id] or set_user before_action
end
```

### Add Query Scopes
```ruby
def collection
  base = super
  base = base.where(published: true) unless current_user.admin?
  base
end
```

### Custom Error Handling
```ruby
rescue_from ActiveRecord::RecordNotFound, with: :not_found

private

def not_found
  fail message: 'Record not found', code: 404
end
```

## TESTING

Run dummy application:
```bash
cd test/dummy
bin/rails db:migrate
bin/rails db:seed
bin/rails server
```

Test API:
```bash
curl http://localhost:3000/api/posts
curl http://localhost:3000/api/posts/1
curl -X POST http://localhost:3000/api/posts -H 'Content-Type: application/json' -d '{"post":{"title":"Test"}}'
```

## DEPENDENCIES

- **rails** >= 6.0
- **kaminari** >= 0.16 - Pagination functionality
- **rails_warp** >= 0.1.0 - Unified response format

## IMPORTANT NOTES FOR AI ASSISTANTS

1. ALWAYS inherit from RailsCurdBase::CurdController for API controllers
2. Use supports_query for query configuration (pagination, sorting, searching, filtering)
3. Use ok() for success responses, fail() for error responses
4. Resource is auto-derived: controller_name.singularize.classify.constantize
5. Override collection() to scope data (current_user.posts, etc.)
6. Use hooks (before_create, after_create, etc.) for callbacks
7. Parameters via resource_params() method (automatically handles strong parameters)
8. Query parameters: page, size, sort, q, filter[field]
9. All query features are optional (enable/disable in supports_query)
10. Filter operators: eq (default), neq, gt, gte, lt, lte, in, nin
11. Success responses use default "success" message from RailsWarp
12. Error responses keep custom messages (validation failed, record not found)
13. Request format: supports both flat {"title":"..."} and nested {"post":{"title":"..."}} formats

## PERFORMANCE TIPS

1. For large datasets, ensure database fields are indexed (especially on filtered/sorted fields)
2. Use select() to limit queried fields (by overriding serialize_resource)
3. Consider caching (in hook methods)
4. For complex queries, override collection() method to optimize SQL

## FILE STRUCTURE

```
app/controllers/rails_curd_base/
  curd_controller.rb       # Main controller
  application_controller.rb

app/controllers/concerns/rails_curd_base/
  queryable.rb             # Query functionality
```

## CONTRIBUTING

Contributions welcome! Please:
- Follow existing code style
- Add tests for new features
- Update documentation
- Submit PR with clear description

## LICENSE

MIT
